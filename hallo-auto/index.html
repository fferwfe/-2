<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>德國心臟病｜6人自動翻牌（統整版）</title>
<style>
  :root{
    --bg:#0b1220; --panel:#111a2e; --text:#e8eefc; --muted:#98a6c7; --acc:#7aa7ff;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Microsoft JhengHei", "PingFang TC", sans-serif;
    background: radial-gradient(1100px 650px at 50% 25%, #16244a 0%, var(--bg) 55%);
    color:var(--text);
  }
  header{
    padding:14px 16px;
    display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center;
    border-bottom: 1px solid rgba(255,255,255,.10);
  }
  .title{font-weight:900}
  .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  button{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color:var(--text);
    padding:10px 12px;
    border-radius:10px;
    cursor:pointer;
    font-weight:800;
  }
  button.primary{background: rgba(122,167,255,.22); border-color: rgba(122,167,255,.35);}
  button:disabled{opacity:.55; cursor:not-allowed}
  .pill{
    padding:8px 10px; border-radius:999px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.12);
    color: var(--muted);
    font-size: 13px;
  }
  .kbd{
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    padding:2px 6px; border-radius:6px;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(255,255,255,.06);
    color:var(--text); font-size:12px;
  }

  main{padding:16px;}
  .board{
    background: rgba(17,26,46,.55);
    border:1px solid rgba(255,255,255,.10);
    border-radius:16px;
    padding:14px;
    display:grid;
    gap:12px;
  }

  .players{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:12px;
  }
  @media (max-width: 900px){
    .players{grid-template-columns: repeat(2, minmax(0, 1fr));}
  }

  .player{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
    border-radius:14px;
    padding:10px;
    position:relative;
    overflow:hidden;
    min-height: 310px;
  }
  .flash{
    position:absolute; inset:0;
    background: rgba(255, 230, 0, .18);
    opacity:0; pointer-events:none;
    transition: opacity .15s ease;
  }
  .player.ring .flash{opacity:1;}
  .row{display:flex; justify-content:space-between; align-items:center; gap:10px;}
  .name{font-weight:900}
  .meta{color:var(--muted); font-size:12px}
  .card{
    width: 180px;
    height: 240px;
    margin: 10px auto 6px auto;
    border-radius:14px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.35);
    box-shadow: 0 14px 35px rgba(0,0,0,.35);
    display:flex; align-items:center; justify-content:center;
  }
  .card img{
    width:100%; height:100%;
    object-fit:cover; display:block;
  }
  .fallback{
    padding:10px;
    font-size: 12px;
    color: rgba(255,255,255,.85);
    text-align:center;
    line-height:1.4;
  }

  .thumbWall{
    margin-top:14px;
    background: rgba(0,0,0,.22);
    border:1px solid rgba(255,255,255,.08);
    border-radius:14px;
    padding:12px;
  }
  .thumbWallHeader{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    margin-bottom:10px;
    font-weight:900;
  }
  .thumbWallHint{font-weight:500; opacity:.75; font-size:12px;}
  .thumbWallGrid{
    display:grid;
    grid-template-columns: repeat(10, minmax(0, 1fr));
    gap:10px;
  }
  @media (max-width: 1000px){
    .thumbWallGrid{ grid-template-columns: repeat(5, minmax(0, 1fr)); }
  }
  .thumbItem{
    border-radius:12px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.05);
  }
  .thumbItem img{
    width:100%;
    height:64px;
    object-fit:cover;
    display:block;
  }
  .thumbCap{
    padding:6px 8px;
    font-size:12px;
    opacity:.9;
    display:flex;
    justify-content:space-between;
    gap:8px;
    white-space:nowrap;
  }
  .thumbCap .who{ font-weight:900; overflow:hidden; text-overflow:ellipsis; }
  .thumbCap .no{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; opacity:.85; }

  .log{
    margin-top:12px;
    background: rgba(0,0,0,.22);
    border:1px solid rgba(255,255,255,.08);
    border-radius:14px;
    padding:10px 12px;
    color: var(--muted);
    font-size: 13px;
    line-height:1.55;
    max-height: 150px;
    overflow:auto;
  }

  .speedWrap{display:flex; align-items:center; gap:8px;}
  input[type="range"]{ width: 160px; }
</style>
</head>
<body>

<header>
  <div class="title">德國心臟病｜6人自動翻牌（統整版）</div>
  <div class="controls">
    <button class="primary" id="btnStart">開始</button>
    <button id="btnPause">暫停/繼續 <span class="kbd">P</span></button>
    <button id="btnBell">按鈴 <span class="kbd">Space</span></button>
    <button id="btnStep">單步 <span class="kbd">S</span></button>
    <button id="btnUndo">上一步 <span class="kbd">U</span></button>
    <button id="btnExport">匯出Excel(CSV)</button>
    <button id="btnReset">重置</button>
    <span class="pill">狀態：<span id="status">停止</span></span>
    <span class="pill speedWrap">
      速度：<input id="speed" type="range" min="200" max="2000" step="50" value="800">
      <span id="speedLabel">800ms</span>
    </span>
  </div>
</header>

<main>
  <section class="board">
    <div class="players" id="players"></div>

    <div class="thumbWall">
      <div class="thumbWallHeader">
        <div>最近 10 張</div>
        <div class="thumbWallHint">（最新在最左）</div>
      </div>
      <div class="thumbWallGrid" id="thumbWallGrid"></div>
    </div>

    <div class="log" id="log"></div>
  </section>
</main>

<script>
/** =========================
 *  你只要改這裡
 *  ========================= */
const PHOTO_COUNT = 12; // <-- 改成你的照片總張數，例如 120
const EXT = "JPG";      // 你的是大寫 JPG
const FOLDER = "photos";

/** =========================
 *  自動產生照片清單：photos/001.JPG ... photos/012.JPG
 *  ========================= */
const photos = Array.from({ length: PHOTO_COUNT }, (_, i) => {
  const n = String(i + 1).padStart(3, "0");
  return `${FOLDER}/${n}.${EXT}`;
});

const playerNames = ["玩家1","玩家2","玩家3","玩家4","玩家5","玩家6"];

/** =========================
 *  狀態
 *  ========================= */
let players = playerNames.map(() => ({ top: null }));
let results = []; // {timestamp, timeLocal, player, image}
let historyStack = []; // {players, results, turnIndex, turns}
let turns = 0;

let turnIndex = 0; // 玩家1→6固定順序
let timer = null;
let running = false;
let paused = false;
let intervalMs = 800;

/** =========================
 *  DOM
 *  ========================= */
const elPlayers = document.getElementById("players");
const elLog = document.getElementById("log");
const elThumbWallGrid = document.getElementById("thumbWallGrid");
const elStatus = document.getElementById("status");
const elSpeed = document.getElementById("speed");
const elSpeedLabel = document.getElementById("speedLabel");

function log(msg){
  const t = new Date().toLocaleTimeString();
  elLog.innerHTML = `<div>[${t}] ${msg}</div>` + elLog.innerHTML;
}

function setStatus(s){
  elStatus.textContent = s;
}

function snapshotState(){
  historyStack.push({
    players: players.map(p => ({ top: p.top ?? null })),
    results: results.slice(),
    turnIndex,
    turns
  });
  if(historyStack.length > 200) historyStack.shift();
}

function undoStep(){
  const prev = historyStack.pop();
  if(!prev){
    log("沒有上一步可以返回。");
    return;
  }
  players = prev.players.map(p => ({ top: p.top }));
  results = prev.results.slice();
  turnIndex = prev.turnIndex ?? 0;
  turns = prev.turns ?? 0;
  render();
  log("已返回上一步（Undo）。");
}

function recordResult(playerIndex, imgPath){
  const now = new Date();
  results.push({
    timestamp: now.toISOString(),
    timeLocal: now.toLocaleTimeString(),
    player: playerNames[playerIndex],
    image: imgPath
  });
}

function renderPlayers(){
  elPlayers.innerHTML = players.map((p, idx) => {
    const src = p.top;
    return `
      <div class="player" data-idx="${idx}">
        <div class="flash"></div>
        <div class="row">
          <div class="name">${playerNames[idx]}</div>
          <div class="meta">第 ${turns} 次</div>
        </div>
        <div class="card">
          ${
            src
            ? `<img src="${src}" alt="card"
                 onerror="this.outerHTML='<div class=&quot;fallback&quot;>圖片載入失敗<br>${src}</div>'">`
            : `<div class="fallback">尚未翻牌</div>`
          }
        </div>
        <div class="meta">${src ? src.split("/").pop() : ""}</div>
      </div>
    `;
  }).join("");
}

function renderThumbWall(){
  const latest = results.slice(-10).reverse(); // 最新在最前
  elThumbWallGrid.innerHTML = latest.map((r, i) => {
    const n = results.length - i;
    return `
      <div class="thumbItem" title="${r.player}｜${r.image}">
        <img src="${r.image}" alt="thumb"
             onerror="this.outerHTML='<div class=&quot;fallback&quot; style=&quot;height:64px;display:flex;align-items:center;justify-content:center;&quot;>縮圖失敗</div>'">
        <div class="thumbCap">
          <span class="who">${r.player}</span>
          <span class="no">#${n}</span>
        </div>
      </div>
    `;
  }).join("");
}

function render(){
  renderPlayers();
  renderThumbWall();
}

function pickRandomPhoto(){
  return photos[Math.floor(Math.random() * photos.length)];
}

function flipOne(){
  snapshotState();

  const who = turnIndex;
  turnIndex = (turnIndex + 1) % players.length;

  const img = pickRandomPhoto();
  players[who].top = img;
  turns += 1;

  recordResult(who, img);
  render();
  log(`${playerNames[who]} 翻牌：${img.split("/").pop()}`);
}

function start(){
  if(running) return;
  running = true;
  paused = false;
  setStatus("進行中");
  timer = setInterval(() => { if(!paused) flipOne(); }, intervalMs);
  log("開始自動翻牌。");
}

function stop(){
  running = false;
  paused = false;
  if(timer){ clearInterval(timer); timer = null; }
  setStatus("停止");
  log("停止。");
}

function togglePause(){
  if(!running){
    // 沒開始就先開始（方便控場）
    start();
  }
  paused = !paused;
  setStatus(paused ? "暫停" : "進行中");
  log(paused ? "已暫停。" : "繼續翻牌。");
}

function ring(){
  // 按鈴：閃一下 + 切換暫停
  togglePause();
  document.querySelectorAll(".player").forEach(el => {
    el.classList.add("ring");
    setTimeout(() => el.classList.remove("ring"), 160);
  });
  log("按鈴（Space）。");
}

function step(){
  if(!running || paused){
    flipOne();
  }else{
    // 進行中時不允許單步，避免混亂
    log("目前正在自動翻牌，請先暫停再單步。");
  }
}

function resetAll(){
  stop();
  players = playerNames.map(() => ({ top: null }));
  results = [];
  historyStack = [];
  turns = 0;
  turnIndex = 0;
  render();
  log("已重置。");
}

function exportCSV(){
  if(!results.length){
    log("目前沒有結果可匯出。");
    return;
  }
  const header = ["timestamp","player","image"];
  const rows = results.map(r => [r.timestamp, r.player, r.image]);
  const csv = "\uFEFF" + [header, ...rows]
    .map(cols => cols.map(v => `"${String(v).replaceAll('"','""')}"`).join(","))
    .join("\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "halli_results.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);

  log("已下載 CSV（Excel 可直接開啟）。");
}

/** =========================
 *  事件
 *  ========================= */
document.getElementById("btnStart").addEventListener("click", start);
document.getElementById("btnPause").addEventListener("click", togglePause);
document.getElementById("btnBell").addEventListener("click", ring);
document.getElementById("btnStep").addEventListener("click", step);
document.getElementById("btnUndo").addEventListener("click", undoStep);
document.getElementById("btnExport").addEventListener("click", exportCSV);
document.getElementById("btnReset").addEventListener("click", resetAll);

elSpeed.addEventListener("input", () => {
  intervalMs = Number(elSpeed.value);
  elSpeedLabel.textContent = `${intervalMs}ms`;
  if(timer){
    clearInterval(timer);
    timer = setInterval(() => { if(!paused) flipOne(); }, intervalMs);
  }
});

window.addEventListener("keydown", (e) => {
  if(e.code === "Space"){
    e.preventDefault();
    ring();
  } else if(e.key.toLowerCase() === "p"){
    togglePause();
  } else if(e.key.toLowerCase() === "s"){
    step();
  } else if(e.key.toLowerCase() === "u"){
    undoStep();
  }
});

/** =========================
 *  初始化
 *  ========================= */
elSpeed.value = String(intervalMs);
elSpeedLabel.textContent = `${intervalMs}ms`;
render();
log(`已載入照片清單：${PHOTO_COUNT} 張（範例：${photos[0]}）`);
</script>
</body>
</html>

