<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>主持人｜德國心臟病</title>
  <style>
    :root{ --bg:#061427; --text:#eaf2ff; --muted:#9bb3d6; --bd:rgba(255,255,255,.12); --card:rgba(255,255,255,.06); --good:#32d583; --warn:#ffd166; }
    body{margin:0;background:linear-gradient(180deg,#040b16,#061427);color:var(--text);font-family:sans-serif;}
    .wrap{max-width:1000px;margin:0 auto;padding:20px;}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:18px;padding:20px;margin-bottom:20px}
    .btn{padding:10px 20px;border-radius:10px;border:none;background:#32d583;font-weight:bold;cursor:pointer}
    .tableGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .imgbox{height:150px;background:rgba(0,0,0,0.3);border-radius:10px;overflow:hidden}
    img{width:100%;height:100%;object-fit:cover}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>主持人控制台</h2>
    <button class="btn" id="btnCreate">建立房間</button>
    <button class="btn" id="btnNext" disabled style="background:#4678ff;color:white">下一輪 (N)</button>
    <button class="btn" id="btnReset" disabled style="background:#666">重設搶答</button>
    <p>PIN: <b id="pin">----</b> | 狀態: <span id="status">未連線</span></p>
    <p>網址: <a id="joinUrl" target="_blank" style="color:#9cc3ff">--</a></p>
  </div>
  <div class="card">
    <h3>搶答：<span id="winner" style="color:var(--good)">等待中</span></h3>
    <div class="tableGrid" id="tableGrid"></div>
  </div>
</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCmbM5JgUphfWil3ImVi7GFtVrfeE7jzm4",
    authDomain: "fe55-dbd87.firebaseapp.com",
    databaseURL: "https://fe55-dbd87-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "fe55-dbd87",
    storageBucket: "fe55-dbd87.appspot.com",
    appId: "1:399575656230:web:e9bbdc7cc1d242a216c3e7"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  let pin = null;

  document.getElementById('btnCreate').onclick = async () => {
    pin = String(Math.floor(100000 + Math.random()*900000));
    await db.ref(`rooms/${pin}`).set({
      status: 'playing', round: 0, buzz: {locked:false}, history: []
    });
    document.getElementById('pin').textContent = pin;
    document.getElementById('joinUrl').href = `join.html#pin=${pin}`;
    document.getElementById('joinUrl').textContent = `join.html#pin=${pin}`;
    document.getElementById('btnNext').disabled = document.getElementById('btnReset').disabled = false;
    db.ref(`rooms/${pin}`).on('value', snap => {
      const room = snap.val();
      document.getElementById('status').textContent = "已連線";
      document.getElementById('winner').textContent = room.buzz?.locked ? room.buzz.winnerName : "等待中";
      const grid = document.getElementById('tableGrid'); grid.innerHTML = '';
      const last = room.history ? room.history[room.history.length-1] : null;
      if(last) last.dealt.forEach(d => {
        grid.innerHTML += `<div class="imgbox"><img src="${d.photo}"></div>`;
      });
    });
  };

  document.getElementById('btnNext').onclick = async () => {
    const snap = await db.ref(`rooms/${pin}`).get();
    const r = snap.val();
    const round = (r.round || 0) + 1;
    const dealt = Array.from({length:6}, () => ({photo: `https://picsum.photos/400/600?sig=${Math.random()}`}));
    const history = (r.history || []).concat([{round, dealt}]);
    await db.ref(`rooms/${pin}`).update({round, history, buzz:{locked:false}});
  };
  document.getElementById('btnReset').onclick = () => db.ref(`rooms/${pin}/buzz`).set({locked:false});
</script>
</body>
</html>
