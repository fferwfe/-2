<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>德國心臟病｜主持人</title>
  <style>
    :root{
      --bg:#061427; --panel:#0b2240; --panel2:#0a1b33; --text:#eaf2ff; --muted:#9bb3d6;
      --good:#32d583; --bad:#ff6b6b; --warn:#ffd166;
      --radius:18px;
    }
    *{box-sizing:border-box;}
    body{margin:0;background:linear-gradient(180deg,#040b16,#061427 40%, #030812);color:var(--text);font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Arial;}
    header{position:sticky;top:0;z-index:10;background:rgba(3,8,18,.75);backdrop-filter: blur(10px);border-bottom:1px solid rgba(255,255,255,.07);}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 16px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .title{font-weight:800;letter-spacing:.5px}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:var(--text);
      padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn.primary{background:rgba(70,120,255,.25);border-color:rgba(70,120,255,.45)}
    .btn.good{background:rgba(50,213,131,.18);border-color:rgba(50,213,131,.45)}
    .btn.bad{background:rgba(255,107,107,.18);border-color:rgba(255,107,107,.45)}
    .btn.warn{background:rgba(255,209,102,.18);border-color:rgba(255,209,102,.45)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10)}
    .pill b{font-size:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.10);border-radius:var(--radius);padding:14px}
    .muted{color:var(--muted)}
    .big{font-size:34px;font-weight:900}
    .kvs{display:grid;grid-template-columns:140px 1fr;gap:8px;margin-top:10px}
    .kvs div{padding:8px 10px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.08);border-radius:12px}
    .players{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .pchip{padding:10px 12px;border-radius:14px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.10);min-width:170px}
    .pchip .name{font-weight:800}
    .pchip .sub{font-size:12px;color:var(--muted);margin-top:4px}
    .log{max-height:240px;overflow:auto;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);padding:10px}
    .logline{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;color:#cfe0ff;margin:6px 0}
    .warnbox{border:1px solid rgba(255,209,102,.35);background:rgba(255,209,102,.08);padding:10px;border-radius:14px}
    a{color:#9cc3ff}
    input,select{background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.14);color:var(--text);padding:10px;border-radius:12px}
    label{font-size:13px;color:var(--muted)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:end;margin-top:10px}
  </style>
</head>
<body>
<header>
  <div class="wrap row">
    <div class="title">德國心臟病｜主持人（Kahoot 加入）</div>
    <div class="row" style="gap:8px;">
      <span class="pill">PIN：<b id="pin">----</b></span>
      <span class="pill">狀態：<b id="status">未開始</b></span>
      <button class="btn primary" id="btnCreate">建立房間</button>
      <button class="btn good" id="btnStart">開始（開啟牌桌）</button>
      <button class="btn warn" id="btnPause">暫停/繼續（P）</button>
      <button class="btn" id="btnNext">下一輪（N）</button>
      <button class="btn" id="btnPrev">上一輪（U）</button>
      <button class="btn" id="btnResetBuzz">清除搶答</button>
      <button class="btn" id="btnExport">匯出Excel(CSV)</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="warnbox" id="hintBox">
    <div style="font-weight:800;margin-bottom:6px;">你要做的事情（一次到位）</div>
    <ol class="muted" style="margin:0 0 0 18px;">
      <li>先按「建立房間」取得 PIN</li>
      <li>玩家用手機開：<b>join.html</b> 輸入 PIN + 名字加入</li>
      <li>你按「開始」後，會把玩家導到 <b>game.html</b>（玩家只能搶）</li>
      <li>你按「下一輪」會自動發 6 張不同照片（同回合不重複）</li>
    </ol>
  </div>

  <div class="grid">
    <div class="card">
      <div class="big">房間設定</div>
      <div class="controls">
        <div>
          <label>玩家數（固定 6 可不動）</label><br>
          <select id="playerCount">
            <option value="6" selected>6</option>
          </select>
        </div>
        <div>
          <label>自動翻牌間隔（毫秒）</label><br>
          <input id="intervalMs" type="number" min="200" step="50" value="900">
        </div>
        <div>
          <label>回合內照片不重複</label><br>
          <select id="noDupInRound">
            <option value="1" selected>是</option>
            <option value="0">否</option>
          </select>
        </div>
        <div>
          <label>跨回合允許重複</label><br>
          <select id="dupAcrossRounds">
            <option value="1" selected>是（你問的「那兩輪呢？」）</option>
            <option value="0">否（整場不重複，照片要夠多）</option>
          </select>
        </div>
        <button class="btn primary" id="btnApply">套用設定到房間</button>
      </div>

      <div class="kvs">
        <div class="muted">加入網址</div><div><a id="joinUrl" target="_blank" rel="noopener">（建立房間後顯示）</a></div>
        <div class="muted">牌桌網址</div><div><a id="gameUrl" target="_blank" rel="noopener">（建立房間後顯示）</a></div>
      </div>
    </div>

    <div class="card">
      <div class="big">玩家清單</div>
      <div class="muted">玩家會自由命名；加入後會出現在這裡（最多 6 位）。</div>
      <div class="players" id="players"></div>

      <div style="height:10px"></div>
      <div class="big" style="font-size:24px;">搶答狀態</div>
      <div class="muted" id="buzzInfo">尚未有人搶答</div>
      <div class="log" id="buzzLog"></div>
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div class="big" style="font-size:24px;">主持人事件紀錄</div>
    <div class="muted">含：回合發牌、搶答勝者、上一輪等。匯出 CSV 也會依此紀錄。</div>
    <div class="log" id="hostLog"></div>
  </div>
</div>

<script type="module">
  // ===== Firebase (Firestore module) =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp,
    collection, onSnapshot, query, orderBy, limit, addDoc, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // 你的 Firebase 設定（你貼給我的那份）
  const firebaseConfig = {
    apiKey: "AIzaSyCmbM5JgUphfWil3ImVi7GFtVrfeE7jzm4",
    authDomain: "fr44-31112.firebaseapp.com",
    projectId: "fr44-31112",
    storageBucket: "fr44-31112.firebasestorage.app",
    messagingSenderId: "399575656230",
    appId: "1:399575656230:web:e9bbdc7cc1d242a216c3e7",
    measurementId: "G-PELSKZC7JF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ===== Helpers =====
  const $ = (id) => document.getElementById(id);
  const baseUrl = new URL('.', location.href); // 兼容 /-2/ 子路徑
  const abs = (path) => new URL(path, baseUrl).toString();

  const logHost = (msg) => {
    const el = document.createElement('div');
    el.className = 'logline';
    el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    $('hostLog').prepend(el);
  };
  const logBuzz = (msg) => {
    const el = document.createElement('div');
    el.className = 'logline';
    el.textContent = msg;
    $('buzzLog').prepend(el);
  };

  function randPin() {
    return String(Math.floor(100000 + Math.random()*900000));
  }

  function shuffle(arr) {
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  async function loadPhotos() {
    // GitHub Pages 下用相對路徑 + baseUrl，避免 404
    const r = await fetch(abs('photos.json'), { cache: 'no-store' });
    if (!r.ok) throw new Error(`photos.json 讀取失敗：${r.status}`);
    const list = await r.json();
    if (!Array.isArray(list) || list.length < 6) throw new Error('photos.json 必須是陣列，且至少 6 張');
    return list;
  }

  // ===== State =====
  let roomPin = null;

  // room document schema:
  // rooms/{pin}:
  //   createdAt, status: 'lobby'|'playing'|'paused'
  //   settings: {playerCount, intervalMs, noDupInRound, dupAcrossRounds}
  //   photos: [...]
  //   deck: [...] (shuffled)
  //   deckIndex: number
  //   round: number
  //   history: [{round, dealt:[{seat, photo}], winner?}]
  //   buzz: {locked:boolean, winnerName?, winnerId?, at?}

  async function createRoom() {
    const pin = randPin();
    const roomRef = doc(db, 'rooms', pin);
    const photos = await loadPhotos();
    const deck = shuffle(photos);

    const settings = {
      playerCount: Number($('playerCount').value),
      intervalMs: Number($('intervalMs').value),
      noDupInRound: $('noDupInRound').value === '1',
      dupAcrossRounds: $('dupAcrossRounds').value === '1'
    };

    await setDoc(roomRef, {
      createdAt: serverTimestamp(),
      status: 'lobby',
      settings,
      photos,
      deck,
      deckIndex: 0,
      round: 0,
      history: [],
      buzz: { locked: false }
    });

    roomPin = pin;
    $('pin').textContent = pin;
    $('status').textContent = '等待加入';
    $('joinUrl').textContent = abs(`join.html?pin=${pin}`);
    $('joinUrl').href = abs(`join.html?pin=${pin}`);
    $('gameUrl').textContent = abs(`game.html?pin=${pin}`);
    $('gameUrl').href = abs(`game.html?pin=${pin}`);

    logHost(`建立房間 PIN=${pin}，載入照片 ${photos.length} 張`);
    subscribeRoom();
    subscribePlayers();
    subscribeBuzz();
  }

  async function applySettings() {
    if (!roomPin) return alert('請先建立房間');
    const roomRef = doc(db, 'rooms', roomPin);
    const settings = {
      playerCount: Number($('playerCount').value),
      intervalMs: Number($('intervalMs').value),
      noDupInRound: $('noDupInRound').value === '1',
      dupAcrossRounds: $('dupAcrossRounds').value === '1'
    };
    await updateDoc(roomRef, { settings });
    logHost(`更新設定：${JSON.stringify(settings)}`);
  }

  async function startGame() {
    if (!roomPin) return alert('請先建立房間');
    const roomRef = doc(db, 'rooms', roomPin);
    await updateDoc(roomRef, { status: 'playing' });
    logHost(`狀態→playing（玩家會自動在 join 頁跳去 game）`);
  }

  async function togglePause() {
    if (!roomPin) return;
    const roomRef = doc(db, 'rooms', roomPin);
    const snap = await getDoc(roomRef);
    const status = snap.data()?.status || 'lobby';
    const next = (status === 'paused') ? 'playing' : 'paused';
    await updateDoc(roomRef, { status: next });
    logHost(`狀態→${next}`);
  }

  // 回合發牌：同回合 6 張不重複（一定），跨回合可重複（依設定）
  async function dealNextRound() {
    if (!roomPin) return alert('請先建立房間');
    const roomRef = doc(db, 'rooms', roomPin);
    const snap = await getDoc(roomRef);
    if (!snap.exists()) return;

    const room = snap.data();
    const settings = room.settings || {};
    const playerCount = settings.playerCount ?? 6;
    const noDupInRound = !!settings.noDupInRound;
    const dupAcrossRounds = !!settings.dupAcrossRounds;

    const photos = room.photos || [];
    let deck = room.deck || shuffle(photos);
    let deckIndex = room.deckIndex ?? 0;
    let round = (room.round ?? 0) + 1;
    let history = room.history || [];

    // 若「整場不重複」，就要從未出現過的集合挑
    const usedAll = new Set();
    if (!dupAcrossRounds) {
      for (const h of history) for (const d of (h.dealt||[])) usedAll.add(d.photo);
    }

    const dealt = [];
    const usedThisRound = new Set();

    const takeOne = () => {
      // 循環抽 deck；若用完就重新洗牌
      for (let tries=0; tries<photos.length*3; tries++){
        if (deckIndex >= deck.length) {
          deck = shuffle(photos);
          deckIndex = 0;
        }
        const candidate = deck[deckIndex++];
        if (noDupInRound && usedThisRound.has(candidate)) continue;
        if (!dupAcrossRounds && usedAll.has(candidate)) continue;
        return candidate;
      }
      // 真的不夠（照片太少又要求整場不重複）就 fallback
      return deck[Math.floor(Math.random()*deck.length)];
    };

    for (let seat=1; seat<=playerCount; seat++){
      const photo = takeOne();
      dealt.push({ seat, photo });
      usedThisRound.add(photo);
    }

    // 寫入本回合資訊 + 清除搶答
    history = history.concat([{ round, dealt, winner: null }]);

    await updateDoc(roomRef, {
      round,
      deck,
      deckIndex,
      history,
      buzz: { locked: false } // 新回合解鎖搶答
    });

    logHost(`第 ${round} 輪發牌完成（${playerCount} 位）`);
  }

  async function undoRound() {
    if (!roomPin) return;
    const roomRef = doc(db, 'rooms', roomPin);
    const snap = await getDoc(roomRef);
    const room = snap.data();
    const history = (room.history || []);
    if (history.length === 0) return alert('沒有上一輪可退');

    history.pop();
    const round = history.length ? history[history.length-1].round : 0;

    await updateDoc(roomRef, {
      history,
      round,
      buzz: { locked: false }
    });

    logHost(`上一輪（U）：回到第 ${round} 輪`);
  }

  async function resetBuzz() {
    if (!roomPin) return;
    await updateDoc(doc(db,'rooms',roomPin), { buzz: { locked: false } });
    logHost('清除搶答（解鎖）');
  }

  async function exportCSV() {
    if (!roomPin) return;
    const roomRef = doc(db,'rooms',roomPin);
    const snap = await getDoc(roomRef);
    const room = snap.data();
    const history = room.history || [];

    // CSV header
    const lines = [
      ['round','seat','photo','winnerName','winnerAt'].join(',')
    ];

    for (const h of history) {
      const winnerName = h.winner?.name || '';
      const winnerAt = h.winner?.at || '';
      for (const d of (h.dealt||[])) {
        lines.push([
          h.round,
          d.seat,
          `"${d.photo}"`,
          `"${winnerName}"`,
          `"${winnerAt}"`
        ].join(','));
      }
    }

    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `heartgame_${roomPin}_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    logHost('已匯出 CSV');
  }

  // ===== Realtime UI subscriptions =====
  let unsubRoom = null, unsubPlayers = null, unsubBuzz = null;

  function subscribeRoom() {
    if (unsubRoom) unsubRoom();
    const roomRef = doc(db,'rooms',roomPin);
    unsubRoom = onSnapshot(roomRef, (snap) => {
      if (!snap.exists()) return;
      const room = snap.data();
      $('status').textContent =
        room.status === 'lobby' ? '等待加入' :
        room.status === 'playing' ? '進行中' :
        room.status === 'paused' ? '暫停' : (room.status||'未知');
    });
  }

  function subscribePlayers() {
    if (unsubPlayers) unsubPlayers();
    const playersRef = collection(db,'rooms',roomPin,'players');
    unsubPlayers = onSnapshot(playersRef, (snap) => {
      const arr = [];
      snap.forEach(d => arr.push({id:d.id, ...d.data()}));
      arr.sort((a,b)=>(a.joinedAt?.seconds||0)-(b.joinedAt?.seconds||0));
      const box = $('players');
      box.innerHTML = '';
      for (const p of arr) {
        const div = document.createElement('div');
        div.className = 'pchip';
        div.innerHTML = `<div class="name">${escapeHtml(p.name||'未命名')}</div>
                         <div class="sub">狀態：${escapeHtml(p.state||'joined')}</div>`;
        box.appendChild(div);
      }
      if (!arr.length) {
        const div = document.createElement('div');
        div.className = 'muted';
        div.textContent = '尚未有玩家加入';
        box.appendChild(div);
      }
    });
  }

  function subscribeBuzz() {
    if (unsubBuzz) unsubBuzz();
    const roomRef = doc(db,'rooms',roomPin);
    unsubBuzz = onSnapshot(roomRef, (snap) => {
      if (!snap.exists()) return;
      const room = snap.data();
      const buzz = room.buzz || {};
      if (!buzz.locked) {
        $('buzzInfo').textContent = '尚未有人搶答（或已清除搶答）';
      } else {
        $('buzzInfo').textContent = `已鎖定：${buzz.winnerName||'未知'}（${buzz.at||''}）`;
      }
    });

    // 另外訂閱 buzzEvents（顯示誰先搶）
    const eventsRef = collection(db,'rooms',roomPin,'buzzEvents');
    const qy = query(eventsRef, orderBy('ts','desc'), limit(20));
    onSnapshot(qy, (snap) => {
      $('buzzLog').innerHTML = '';
      snap.forEach(d=>{
        const e = d.data();
        const line = `${new Date(e.ts?.toDate?.()||Date.now()).toLocaleTimeString()}  ${e.name}  BUZZ`;
        logBuzz(line);
      });
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c)=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));
  }

  // ===== Keybindings =====
  window.addEventListener('keydown', (e) => {
    if (e.key.toLowerCase() === 'p') togglePause();
    if (e.key.toLowerCase() === 'n') dealNextRound();
    if (e.key.toLowerCase() === 'u') undoRound();
  });

  // ===== Buttons =====
  $('btnCreate').onclick = createRoom;
  $('btnApply').onclick = applySettings;
  $('btnStart').onclick = startGame;
  $('btnPause').onclick = togglePause;
  $('btnNext').onclick = dealNextRound;
  $('btnPrev').onclick = undoRound;
  $('btnResetBuzz').onclick = resetBuzz;
  $('btnExport').onclick = exportCSV;

  // 若網址帶 pin=xxxxx，直接接管該房間（方便你主持人重開）
  const urlPin = new URLSearchParams(location.search).get('pin');
  if (urlPin) {
    roomPin = urlPin;
    $('pin').textContent = urlPin;
    $('joinUrl').textContent = abs(`join.html?pin=${urlPin}`);
    $('joinUrl').href = abs(`join.html?pin=${urlPin}`);
    $('gameUrl').textContent = abs(`game.html?pin=${urlPin}`);
    $('gameUrl').href = abs(`game.html?pin=${urlPin}`);
    subscribeRoom(); subscribePlayers(); subscribeBuzz();
    logHost(`以 pin=${urlPin} 進入主持人模式`);
  } else {
    logHost('請先按「建立房間」');
  }
</script>
</body>
</html>

