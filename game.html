<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¾·åœ‹å¿ƒè‡Ÿç—…ï¼ˆKahoot åŒæ­¥ç‰ˆï¼‰</title>

  <!-- QRCodeï¼ˆå…¨åŸŸ QRCode ç‰©ä»¶ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <style>
    body{font-family:system-ui,"Microsoft JhengHei";margin:20px;max-width:1200px}
    .muted{opacity:.75}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
    button{padding:12px 16px;border:0;border-radius:12px;font-weight:900;cursor:pointer}
    .primary{background:#2b6dff;color:#fff}
    .secondary{background:#eee}
    .danger{background:#ff3b30;color:#fff}
    button:disabled{opacity:.5;cursor:not-allowed}
    code{background:#f2f2f2;padding:2px 6px;border-radius:6px}

    .card{border:1px solid #ddd;border-radius:12px;padding:14px;margin-top:12px}
    .big{font-size:20px;font-weight:900}

    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns: repeat(2, minmax(0, 1fr));}
    }
    .slot{
      border:1px solid #ddd;border-radius:14px;padding:10px;background:#fafafa;
    }
    .slotHead{display:flex;justify-content:space-between;align-items:baseline;gap:10px}
    .slotName{font-weight:900}
    .slotMeta{font-size:12px;opacity:.7}

    .imgBox{
      width:100%; aspect-ratio: 3/4;
      border-radius:12px; overflow:hidden;
      border:1px solid rgba(0,0,0,.12);
      background:#111;
      display:flex;align-items:center;justify-content:center;
      margin-top:8px;
    }
    .imgBox img{width:100%;height:100%;object-fit:cover;display:block}
    .fallback{color:#fff;font-size:12px;text-align:center;padding:10px;line-height:1.4}

    /* Winner overlay animations */
    @keyframes boom {
      0%   { transform:scale(0.3); opacity:0; }
      60%  { transform:scale(1.15); opacity:1; }
      100% { transform:scale(1); opacity:1; }
    }
    @keyframes flash {
      0%,100% { background:rgba(0,0,0,0.75); }
      50%     { background:rgba(255,255,255,0.2); }
    }
    .winner-show { animation: flash 0.15s linear 3; }
    .winner-text-show { animation: boom 0.4s cubic-bezier(.2,.9,.3,1.2) forwards; }
  </style>
</head>

<body>
  <h1>å¾·åœ‹å¿ƒè‡Ÿç—…ï¼ˆåŒæ­¥ç‰ˆï¼‰</h1>
  <div class="muted">
    æˆ¿é–“ PINï¼š<code id="pin"></code>
    <span id="role" class="muted"></span>
  </div>

  <div class="card">
    <div class="big" id="state">è¼‰å…¥ä¸­â€¦</div>
    <div class="big" id="winnerTextLine">æ¶éˆ´ï¼šå°šæœªæœ‰äººæ¶åˆ°</div>

    <!-- ä¸»æŒäººæ§åˆ¶ -->
    <div class="row" id="hostControls" style="display:none">
      <button class="primary" id="btnFlip">ç¿»ç‰Œï¼ˆä¸‹ä¸€ä½ï¼‰</button>

      <button class="primary" id="btnAuto">é–‹å§‹è‡ªå‹•æ’­æ”¾</button>
      <button class="secondary" id="btnPause" disabled>æš«åœ</button>

      <button class="secondary" id="btnResetRound">ä¸‹ä¸€è¼ªï¼ˆæ¸…ç©ºç‰Œé¢ï¼‰</button>

      <span class="muted" id="photoStatus">ç…§ç‰‡æ¸…å–®ï¼šå°šæœªè¼‰å…¥</span>
      <span class="muted">å¿«æ·éµï¼šSpace æ’­æ”¾/æš«åœã€N å–®æ­¥ç¿»ç‰Œ</span>
    </div>

    <!-- ç©å®¶æ§åˆ¶ -->
    <div class="row" id="playerControls" style="display:none">
      <button class="danger" id="btnBuzz">æ¶éˆ´ï¼</button>
    </div>

    <div class="muted">
      è¦å‰‡ï¼šç¿»ç‰Œå›ºå®šé †åºã€Œç©å®¶1 â†’ ç©å®¶6ã€å¾ªç’°ï¼›æ¯ç¿»ä¸€å¼µç‰Œï¼Œè‡ªå‹•é–‹æ”¾ä¸€æ¬¡æ¶éˆ´ï¼›ç¬¬ä¸€å€‹æ¶åˆ°è€…é–å®šã€‚
    </div>
  </div>

  <!-- ä¸»æŒäººæ‰çœ‹å¾—åˆ°çš„ï¼šQR + è¨˜åˆ†æ¿ -->
  <div class="card" id="hostExtras" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div>
        <div class="big">ğŸ“± ç©å®¶åŠ å…¥ï¼ˆæƒ QR é€² join.htmlï¼‰</div>
        <div class="muted">join.htmlï¼š<code id="joinUrl"></code></div>
        <div class="muted">ç©å®¶é€²å…¥å¾Œï¼Œè¼¸å…¥ PINï¼ˆä¸Šæ–¹ï¼‰ï¼‹è‡ªç”±å‘½å</div>
      </div>
      <canvas id="qrcode"></canvas>
    </div>

    <div style="margin-top:12px">
      <div class="big">ğŸ† è¨˜åˆ†æ¿</div>
      <ul id="scoreBoard"></ul>
      <div class="muted">è¨ˆåˆ†ï¼šæ¯æ¬¡æ¶åˆ° +1ï¼ˆä»¥ã€Œè‡ªç”±å‘½åã€ä½œç‚ºéšŠå/äººåï¼‰</div>
    </div>
  </div>

  <div class="card">
    <div class="big">å…­ä½ç©å®¶ç‰Œé¢</div>
    <div class="muted">å›ºå®šé †åºï¼šç©å®¶1 â†’ ç©å®¶6 å¾ªç’°ç¿»ç‰Œ</div>
    <div class="grid" id="board"></div>
  </div>

  <!-- éŸ³æ•ˆï¼šä½ éœ€è¦åœ¨ repo æ ¹ç›®éŒ„æ”¾ sounds/flip.mp3ã€sounds/buzz.mp3 -->
  <audio id="flipSound" src="sounds/flip.mp3" preload="auto"></audio>
  <audio id="buzzSound" src="sounds/buzz.mp3" preload="auto"></audio>

  <!-- çˆ†ç‚¸å‹•ç•«å±¤ï¼ˆä¸»æŒäººç”¨ï¼‰ -->
  <div id="winnerOverlay" style="
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.75);
    z-index:9999;
  ">
    <div id="winnerOverlayText" style="
      color:#fff;
      font-size:72px;
      font-weight:900;
      text-align:center;
      line-height:1.15;
      transform:scale(0.3);
      opacity:0;
      padding:20px;
      word-break:break-word;
    ">æ¶åˆ°ï¼</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore,
      doc, getDoc, updateDoc,
      onSnapshot, collection,
      runTransaction, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ======= æŠŠé€™æ®µæ›æˆä½ çš„ firebaseConfigï¼ˆhost.html / join.html / game.html ä¸‰ä»½è¦ä¸€è‡´ï¼‰ =======
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      appId: "YOUR_APP_ID",
    };
    // ============================================================================================

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // -------- URL params --------
    const qs = new URLSearchParams(location.search);
    const pin = qs.get("pin");
    const playerId = qs.get("player");
    const isHost = qs.get("host") === "1";
    const secret = qs.get("secret");

    if (!pin) {
      document.body.innerHTML = "ç¼ºå°‘ pinã€‚è«‹å¾ host.html æˆ– join.html é€²å…¥ã€‚";
      throw new Error("missing pin");
    }

    // -------- DOM --------
    const elPin = document.getElementById("pin");
    const elRole = document.getElementById("role");
    const elState = document.getElementById("state");
    const elWinnerLine = document.getElementById("winnerTextLine");

    const hostControls = document.getElementById("hostControls");
    const playerControls = document.getElementById("playerControls");
    const hostExtras = document.getElementById("hostExtras");

    const btnFlip = document.getElementById("btnFlip");
    const btnAuto = document.getElementById("btnAuto");
    const btnPause = document.getElementById("btnPause");
    const btnResetRound = document.getElementById("btnResetRound");
    const btnBuzz = document.getElementById("btnBuzz");

    const elPhotoStatus = document.getElementById("photoStatus");
    const elBoard = document.getElementById("board");

    const flipSound = document.getElementById("flipSound");
    const buzzSound = document.getElementById("buzzSound");

    const overlay = document.getElementById("winnerOverlay");
    const overlayText = document.getElementById("winnerOverlayText");

    const scoreBoard = document.getElementById("scoreBoard");
    const joinUrlEl = document.getElementById("joinUrl");
    const qrCanvas = document.getElementById("qrcode");

    elPin.textContent = pin;
    elRole.textContent = isHost ? "ï¼ˆä¸»æŒäººï¼‰" : "ï¼ˆç©å®¶ï¼‰";

    hostControls.style.display = isHost ? "flex" : "none";
    hostExtras.style.display = isHost ? "block" : "none";
    playerControls.style.display = (!isHost && playerId) ? "flex" : "none";

    const roomRef = doc(db, "rooms", pin);

    // -------- Board rendering --------
    const slots = Array.from({ length: 6 }, (_, i) => `ç©å®¶${i + 1}`);

    function renderBoard(images) {
      elBoard.innerHTML = slots.map((name, idx) => {
        const src = images?.[idx] ?? null;
        const label = src ? src.split("/").pop() : "";
        return `
          <div class="slot">
            <div class="slotHead">
              <div class="slotName">${name}</div>
              <div class="slotMeta">${label}</div>
            </div>
            <div class="imgBox">
              ${
                src
                  ? `<img src="${src}" alt="${name}"
                      onerror="this.outerHTML='<div class=&quot;fallback&quot;>åœ–ç‰‡è¼‰å…¥å¤±æ•—<br>${src}</div>'">`
                  : `<div class="fallback">å°šæœªç¿»ç‰Œ</div>`
              }
            </div>
          </div>
        `;
      }).join("");
    }

    renderBoard(Array(6).fill(null));

    // -------- QR code (host only) --------
    const base = location.origin + location.pathname.replace(/\/[^/]*$/, "/");
    const joinUrl = base + "join.html";
    if (isHost) {
      joinUrlEl.textContent = joinUrl;
      try {
        if (window.QRCode?.toCanvas) {
          window.QRCode.toCanvas(qrCanvas, joinUrl, { width: 220 });
        } else {
          joinUrlEl.textContent = joinUrl + "ï¼ˆQRCode å¥—ä»¶è¼‰å…¥å¤±æ•—ï¼‰";
        }
      } catch (e) {
        console.error(e);
        joinUrlEl.textContent = joinUrl + "ï¼ˆQRCode ç”¢ç”Ÿå¤±æ•—ï¼‰";
      }
    }

    // -------- Scoreboard (host only) --------
    if (isHost) {
      onSnapshot(collection(db, "rooms", pin, "scores"), (qs2) => {
        const arr = [];
        qs2.forEach(d => arr.push({ name: d.id, score: Number(d.data().value ?? 0) }));
        arr.sort((a, b) => b.score - a.score);

        scoreBoard.innerHTML = arr.length
          ? arr.map(s => `<li><b>${escapeHtml(s.name)}</b>ï¼š${s.score}</li>`).join("")
          : `<li class="muted">å°šç„¡å¾—åˆ†</li>`;
      });
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[c]));
    }

    // -------- photos.json (host only, for dealing cards) --------
    let photoList = [];

    async function loadPhotos() {
      try {
        const r = await fetch("photos.json", { cache: "no-store" });
        if (!r.ok) throw new Error("photos.json status " + r.status);
        const data = await r.json();
        if (!Array.isArray(data) || data.length === 0) throw new Error("photos.json empty");
        photoList = data;
        elPhotoStatus.textContent = `ç…§ç‰‡æ¸…å–®ï¼šå·²è¼‰å…¥ ${photoList.length} å¼µ`;
      } catch (e) {
        console.error(e);
        elPhotoStatus.textContent = "ç…§ç‰‡æ¸…å–®ï¼šè¼‰å…¥å¤±æ•—ï¼ˆæª¢æŸ¥ photos.json è·¯å¾‘/å¤§å°å¯«ï¼‰";
      }
    }

    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // åŒä¸€è¼ªï¼ˆ6 å¼µï¼‰ä¸é‡è¤‡ï¼›è‹¥ä½ è¦ã€Œå…©è¼ªä¸é‡è¤‡ã€æŠŠ 1 æ”¹ 2ï¼ˆéœ€è‡³å°‘ 12 å¼µç…§ç‰‡ï¼‰
    const NO_REPEAT_ROUNDS = 1;

    function makeDeck() {
      const need = 6 * NO_REPEAT_ROUNDS;
      if (photoList.length < need) {
        throw new Error(`ç…§ç‰‡ä¸è¶³ï¼šéœ€è¦è‡³å°‘ ${need} å¼µï¼Œç¾åœ¨åªæœ‰ ${photoList.length} å¼µ`);
      }
      return shuffle(photoList).slice(0, need);
    }

    // -------- Host auth helper --------
    async function assertHost() {
      const snap = await getDoc(roomRef);
      if (!snap.exists()) throw new Error("room missing");
      if (snap.data().hostSecret !== secret) throw new Error("host secret mismatch");
      return snap.data();
    }

    // -------- Flip (host only): fixed order player1->player6 --------
    async function hostFlip() {
      if (!isHost) return;

      btnFlip.disabled = true;
      try {
        await assertHost();
        if (photoList.length === 0) throw new Error("photos.json not loaded");

        await runTransaction(db, async (tx) => {
          const s = await tx.get(roomRef);
          if (!s.exists()) throw new Error("room missing");
          const r = s.data();

          const board = Array.isArray(r.boardImages) ? r.boardImages.slice(0, 6) : Array(6).fill(null);
          let turnIndex = Number.isInteger(r.turnIndex) ? r.turnIndex : 0;
          let deck = Array.isArray(r.deck) ? r.deck.slice() : [];

          // è‹¥ç‰Œå †ç”¨å®Œï¼Œç”¢ç”Ÿæ–°çš„ä¸€è¼ªç‰Œå †ï¼ˆç¢ºä¿åŒä¸€è¼ªä¸é‡è¤‡ï¼‰
          if (deck.length === 0) {
            deck = makeDeck();
          }

          const who = turnIndex;     // 0..5
          const img = deck.pop();    // æœ¬è¼ªä¸é‡è¤‡
          board[who] = img;

          turnIndex = (turnIndex + 1) % 6;

          // âœ… ç¿»ç‰Œ = è‡ªå‹•é–‹æ”¾æ¶éˆ´ï¼ˆä¸¦é‡ç½® winnerï¼‰
          tx.update(roomRef, {
            boardImages: board,
            turnIndex,
            deck,
            lastFlip: { player: who, image: img },
            lastFlipAt: serverTimestamp(),

            buzzOpen: true,
            buzzWinnerName: null,
            buzzAt: null
          });
        });

        // ç¿»ç‰ŒéŸ³æ•ˆï¼ˆhost onlyï¼‰
        try { flipSound.currentTime = 0; await flipSound.play(); } catch {}
      } catch (e) {
        console.error(e);
        alert("ç¿»ç‰Œå¤±æ•—ï¼š" + (e?.message ?? e));
      } finally {
        btnFlip.disabled = false;
      }
    }

    // -------- Reset round (host only): clear board + new round number --------
    async function resetRound() {
      if (!isHost) return;
      try {
        const r = await assertHost();
        await updateDoc(roomRef, {
          boardImages: Array(6).fill(null),
          turnIndex: 0,
          deck: [],
          round: (r.round ?? 1) + 1,

          buzzOpen: false,
          buzzWinnerName: null,
          buzzAt: null
        });
      } catch (e) {
        console.error(e);
        alert("ä¸‹ä¸€è¼ªå¤±æ•—ï¼š" + (e?.message ?? e));
      }
    }

    // -------- Auto play (host only) --------
    const AUTO_INTERVAL_MS = 800;
    let autoTimer = null;
    let isAutoRunning = false;

    function setAutoUI() {
      if (!isHost) return;
      btnAuto.disabled = isAutoRunning;
      btnPause.disabled = !isAutoRunning;
      btnAuto.textContent = isAutoRunning ? "è‡ªå‹•æ’­æ”¾ä¸­â€¦" : "é–‹å§‹è‡ªå‹•æ’­æ”¾";
    }

    async function startAuto() {
      if (!isHost || isAutoRunning) return;
      if (photoList.length === 0) {
        alert("photos.json å°šæœªè¼‰å…¥æˆåŠŸï¼Œè«‹ç¢ºèª https://fferwfe.github.io/-2/photos.json å¯æ‰“é–‹ã€‚");
        return;
      }
      isAutoRunning = true;
      setAutoUI();

      await hostFlip();

      autoTimer = setInterval(async () => {
        if (btnFlip.disabled) return; // é¿å…é‡å…¥
        await hostFlip();
      }, AUTO_INTERVAL_MS);
    }

    function stopAuto() {
      if (!isHost || !isAutoRunning) return;
      isAutoRunning = false;
      if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
      }
      setAutoUI();
    }

    function toggleAuto() {
      if (isAutoRunning) stopAuto();
      else startAuto();
    }

    // -------- Player buzz (mobile only): first wins + score +1 --------
    btnBuzz?.addEventListener("click", async () => {
      if (!playerId) {
        alert("ç¼ºå°‘ playerIdï¼Œè«‹å¾ join.html åŠ å…¥å¾Œå†é€²ä¾†ã€‚");
        return;
      }
      btnBuzz.disabled = true;

      const playerRef = doc(db, "rooms", pin, "players", playerId);

      try {
        await runTransaction(db, async (tx) => {
          const roomSnap = await tx.get(roomRef);
          if (!roomSnap.exists()) throw new Error("room missing");
          const r = roomSnap.data();

          if (!r.buzzOpen) return;
          if (r.buzzWinnerName) return;

          const pSnap = await tx.get(playerRef);
          if (!pSnap.exists()) throw new Error("player missing");
          const p = pSnap.data();
          const name = String(p.name ?? "").trim();
          if (!name) throw new Error("player name missing");

          // winner
          tx.update(roomRef, {
            buzzOpen: false,
            buzzWinnerName: name,
            buzzAt: serverTimestamp()
          });

          // score +1
          const scoreRef = doc(db, "rooms", pin, "scores", name);
          const scoreSnap = await tx.get(scoreRef);
          const current = scoreSnap.exists() ? Number(scoreSnap.data().value ?? 0) : 0;
          tx.set(scoreRef, { value: current + 1 }, { merge: true });
        });
      } catch (e) {
        console.error(e);
      }
    });

    // -------- Winner overlay + buzz sound (host only overlay, sound on all optional) --------
    let lastWinnerSeen = null;

    function showWinnerOverlay(name) {
      overlayText.innerHTML = `ğŸ””<br>${escapeHtml(name)}<br>æ¶åˆ°ï¼`;
      overlay.style.display = "flex";

      overlay.classList.remove("winner-show");
      overlayText.classList.remove("winner-text-show");
      void overlay.offsetWidth;

      overlay.classList.add("winner-show");
      overlayText.classList.add("winner-text-show");

      setTimeout(() => { overlay.style.display = "none"; }, 1500);
    }

    async function playBuzzSound() {
      try { buzzSound.currentTime = 0; await buzzSound.play(); } catch {}
    }

    // -------- Room live sync --------
    onSnapshot(roomRef, (snap) => {
      if (!snap.exists()) {
        elState.textContent = "æˆ¿é–“ä¸å­˜åœ¨æˆ–å·²åˆªé™¤ã€‚";
        return;
      }
      const r = snap.data();

      const round = r.round ?? 1;
      const buzz = r.buzzOpen ? "é–‹æ”¾" : "é—œé–‰";
      const next = Number.isInteger(r.turnIndex) ? (r.turnIndex + 1) : 1;

      elState.textContent = `ç¬¬ ${round} è¼ªï½œæ¶éˆ´ï¼š${buzz}ï½œä¸‹ä¸€ä½ç¿»ç‰Œï¼šç©å®¶${next}`;

      // render board
      renderBoard(r.boardImages);

      // player button state
      if (!isHost && btnBuzz) {
        btnBuzz.disabled = !r.buzzOpen || !!r.buzzWinnerName;
      }

      // winner display
      if (r.buzzWinnerName) {
        elWinnerLine.textContent = `æ¶åˆ°çš„æ˜¯ï¼š${r.buzzWinnerName}`;

        // only trigger once per new winner
        if (r.buzzWinnerName !== lastWinnerSeen) {
          lastWinnerSeen = r.buzzWinnerName;

          // sound (all clients). è‹¥ä½ åªæƒ³ä¸»æŒäººæœ‰è²ï¼ŒæŠŠ if(isHost) åŒ…ä½å³å¯
          playBuzzSound();

          // overlay (host only)
          if (isHost) showWinnerOverlay(r.buzzWinnerName);
        }
      } else {
        elWinnerLine.textContent = "æ¶éˆ´ï¼šå°šæœªæœ‰äººæ¶åˆ°";
        lastWinnerSeen = null;
      }
    });

    // -------- Host UI events + hotkeys --------
    btnFlip?.addEventListener("click", hostFlip);
    btnResetRound?.addEventListener("click", resetRound);

    btnAuto?.addEventListener("click", startAuto);
    btnPause?.addEventListener("click", stopAuto);

    document.addEventListener("keydown", async (e) => {
      if (!isHost) return;

      const tag = (e.target?.tagName || "").toLowerCase();
      if (tag === "input" || tag === "textarea" || e.target?.isContentEditable) return;

      if (e.code === "Space") {
        e.preventDefault();
        toggleAuto();
      } else if (e.key === "n" || e.key === "N") {
        e.preventDefault();
        await hostFlip();
      }
    });

    // -------- Init (host only) --------
    if (isHost) {
      setAutoUI();
      await loadPhotos();

      // è‹¥ç¬¬ä¸€æ¬¡é€²å…¥å°šæœªåˆå§‹åŒ– boardImagesï¼Œä¸»æŒäººè£œåˆå§‹åŒ–ä¸€æ¬¡ï¼ˆä¸å½±éŸ¿æ—¢æœ‰ï¼‰
      try {
        const r = await assertHost();
        if (!Array.isArray(r.boardImages)) {
          await updateDoc(roomRef, {
            boardImages: Array(6).fill(null),
            turnIndex: 0,
            deck: []
          });
        }
      } catch (e) {
        console.error(e);
      }
    }
  </script>
</body>
</html>
